<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>WebSocket ì±„íŒ…</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 0 16px;
        }

        h1 {
            font-size: 20px;
        }

        #status {
            font-size: 13px;
            margin-bottom: 8px;
        }

        #messages {
            border: 1px solid #ccc;
            border-radius: 4px;
            height: 300px;
            padding: 8px;
            overflow-y: auto;
            font-size: 14px;
            background: #fafafa;
            white-space: pre-wrap;
        }

        .system {
            color: #666;
        }

        .me {
            color: #0055cc;
        }

        .other {
            color: #222;
        }

        #inputArea {
            margin-top: 10px;
            display: flex;
            gap: 6px;
        }

        #msg {
            flex: 1;
            padding: 6px 8px;
            font-size: 14px;
        }

        #sendBtn {
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h1>WebSocket ì±„íŒ…ë°©</h1>
<div id="status">ì—°ê²° ì¤‘...</div>

<div id="messages"></div>

<div id="inputArea">
    <input id="msg" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”" autocomplete="off" />
    <button id="sendBtn">ë³´ë‚´ê¸°</button>
</div>

<script>
    const statusEl = document.getElementById("status");
    const messagesEl = document.getElementById("messages");
    const msgInput = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");

    const username = prompt("ë‹‰ë„¤ìž„ì„ ìž…ë ¥í•˜ì„¸ìš”", "guest" + Math.floor(Math.random() * 1000));

    // ðŸ‘‰ ìž…ìž¥í•  ë ˆì´ë“œë°© ID
    const roomId = prompt("ìž…ìž¥í•  ë ˆì´ë“œë°© IDë¥¼ ìž…ë ¥í•˜ì„¸ìš”", "raid-1");

    let socket;

    function addMessage(text, cssClass) {
        const div = document.createElement("div");
        if (cssClass) div.className = cssClass;
        div.textContent = text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setStatus(text) {
        statusEl.textContent = text;
    }

    function connect() {
        console.log("ì›¹ì†Œì¼“ ì—°ê²° ì‹œë„");
        socket = new WebSocket("ws://" + window.location.host + "/ws/chat");

        socket.onopen = () => {
            console.log("onopen");
            setStatus("âœ… ì„œë²„ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. (ë°©: " + roomId + ")");
            addMessage("ì‹œìŠ¤í…œ: " + roomId + " ë°©ì— ìž…ìž¥ ì‹œë„ ì¤‘...", "system");

            // ðŸ”¹ ì„œë²„ì— JOIN ë©”ì‹œì§€ ë³´ë‚´ê¸° (roomId í¬í•¨)
            const joinMsg = {
                type: "JOIN",
                sender: username,
                roomId: roomId,
                message: ""
            };
            socket.send(JSON.stringify(joinMsg));
        };

        socket.onmessage = (event) => {
            console.log("onmessage raw:", event.data);
            let data;

            try {
                data = JSON.parse(event.data);
            } catch (e) {
                console.error("JSON íŒŒì‹± ì‹¤íŒ¨, raw ì¶œë ¥:", event.data);
                addMessage(event.data, "other");
                return;
            }

            let text = "";
            let cssClass = "other";

            switch (data.type) {
                case "SYSTEM":
                    text = "ì‹œìŠ¤í…œ: " + (data.message || "");
                    cssClass = "system";
                    break;
                case "CHAT":
                    if (data.sender === username) {
                        text = "ë‚˜: " + (data.message || "");
                        cssClass = "me";
                    } else {
                        text = (data.sender || "ì•Œ ìˆ˜ ì—†ìŒ") + ": " + (data.message || "");
                        cssClass = "other";
                    }
                    break;
                case "ATTACK_RESULT":
                    text = "[ê³µê²©] " + (data.message || "");
                    if (data.bossHp != null && data.maxHp != null) {
                        text += " (ë³´ìŠ¤ HP: " + data.bossHp + " / " + data.maxHp + ")";
                    }
                    cssClass = "system";
                    break;
                default:
                    text = "[" + data.type + "] " +
                        (data.sender || "") + " " +
                        (data.message || "");
                    cssClass = "other";
            }

            addMessage(text, cssClass);
        };

        socket.onclose = (event) => {
            console.log("onclose:", event);
            setStatus("âŒ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìž¬ì ‘ì† ê°€ëŠ¥)");
            addMessage("ì‹œìŠ¤í…œ: ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "system");
        };

        socket.onerror = (error) => {
            console.log("onerror:", error);
            setStatus("âš  ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            addMessage("ì‹œìŠ¤í…œ: ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "system");
        };
    }

    function sendMessage() {
        const text = msgInput.value.trim();
        if (!text || !socket || socket.readyState !== WebSocket.OPEN) {
            return;
        }

        if (text.startsWith("/atk")) {
            // ê³µê²©
            const parts = text.split(" ");
            let damage = null;

            if (parts.length > 1) {
                const parsed = parseInt(parts[1], 10);
                if (!isNaN(parsed)) {
                    damage = parsed;
                }
            }

            const attackMsg = {
                type: "ATTACK",
                sender: username,
                roomId: roomId,
                damage: damage
            };

            socket.send(JSON.stringify(attackMsg));
        } else {
            // ì¼ë°˜ ì±„íŒ…
            const msg = {
                type: "CHAT",
                sender: username,
                roomId: roomId,
                message: text
            };
            socket.send(JSON.stringify(msg));
        }

        msgInput.value = "";
        msgInput.focus();
    }

    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            sendMessage();
        }
    });

    connect();
</script>
</body>
</html>
